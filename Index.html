<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Closing Cost & Escrow Calculator – Dark Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-secondary: #020617;
      --card: #0b1120;
      --card2: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.18);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-md: 10px;
      --shadow-soft: 0 20px 45px rgba(0,0,0,0.55);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
    }

    .app {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 14px 40px;
    }

    header {
      margin-bottom: 18px;
    }

    header h1 {
      margin: 0 0 4px;
      font-size: 1.7rem;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 0.86rem;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid transparent;
      font-size: 0.9rem;
      color: var(--muted);
      background: rgba(15,23,42,0.9);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tab-btn span {
      font-size: 0.68rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .tab-btn.active {
      background: linear-gradient(120deg, var(--accent-soft), rgba(56,189,248,0.1));
      border-color: var(--accent);
      color: var(--text);
    }

    .sheet {
      display: none;
      animation: fadeIn 0.18s ease-out;
    }
    .sheet.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 15px;
      margin-bottom: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, #1f2937 0, #020617 80%);
      border-radius: var(--radius-lg);
      padding: 14px 14px 16px;
      border: 1px solid rgba(15,23,42,0.95);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 1rem;
    }

    .card p.subtitle {
      margin: 0 0 10px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .badge {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .field-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .field-row label {
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .field-row small {
      font-size: 0.7rem;
      color: var(--muted);
    }

    input, select {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 7px 9px;
      font-size: 0.85rem;
      background: rgba(15,23,42,0.95);
      color: var(--text);
    }

    input:focus, select:focus {
      outline: 1px solid var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4);
    }

    .inline {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .inline label {
      margin: 0;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 4px;
    }

    .summary-card {
      background: linear-gradient(135deg, rgba(34,197,94,0.16), rgba(15,23,42,0.96));
      border-radius: var(--radius-lg);
      padding: 9px 11px;
      border: 1px solid rgba(34,197,94,0.55);
    }

    .summary-card label {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .summary-card .value {
      margin-top: 4px;
      font-size: 1rem;
      font-weight: 600;
    }

    .tagline {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th, td {
      border-bottom: 1px solid rgba(31,41,55,0.9);
      padding: 5px 6px;
      text-align: left;
    }

    th {
      color: var(--muted);
      font-weight: 500;
      background: rgba(15,23,42,0.96);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.8);
    }

    .scroll {
      max-height: 260px;
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
    }

    .number-cell {
      width: 90px;
    }

    .muted {
      color: var(--muted);
      font-size: 0.75rem;
    }

    @media (max-width: 640px) {
      .app { padding-inline: 10px; }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Closing Cost & Escrow Calculator</h1>
    <p>Dark-mode web version of your Excel workbook. All math is based on your Sheet 1–3 formulas.</p>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-sheet="sheet1">
      Sheet 1 – Closing Cost
      <span>Primary</span>
    </button>
    <button class="tab-btn" data-sheet="sheet2">
      Sheet 2 – Escrow Schedule
      <span>Escrow</span>
    </button>
    <button class="tab-btn" data-sheet="sheet3">
      Sheet 3 – Escrow Summary
      <span>Summary</span>
    </button>
  </div>

  <!-- ============ SHEET 1 ============ -->
  <section id="sheet1" class="sheet active">
    <div class="grid">
      <div class="card">
        <span class="badge">Borrower</span>
        <h2>Borrower & Property</h2>
        <p class="subtitle">Top-left area of your Sheet 1.</p>

        <div class="field-row">
          <label>Name</label>
          <input id="s1_name" type="text" placeholder="Borrower name">
        </div>
        <div class="field-row">
          <label>Property</label>
          <input id="s1_property" type="text" placeholder="Property address">
        </div>
        <div class="field-row">
          <label>Closing Date</label>
          <input id="s1_closingDate" type="date">
        </div>
      </div>

      <div class="card">
        <span class="badge">Loan</span>
        <h2>Loan Terms & Payment</h2>
        <p class="subtitle">Purchase price, loan amount, rate, and monthly payment.</p>

        <div class="field-row">
          <label>Purchase price</label>
          <input id="s1_purchasePrice" type="number" value="1650000" oninput="recalcAll()">
        </div>
        <div class="field-row">
          <label>Contract Deposit</label>
          <input id="s1_contractDeposit" type="number" value="260000" oninput="recalcAll()">
        </div>
        <div class="field-row">
          <label>Seller Concession</label>
          <input id="s1_sellerConcession" type="number" value="0" oninput="recalcAll()">
        </div>
        <div class="field-row">
          <label>Loan amount</label>
          <input id="s1_loanAmount" type="number" value="1222000" oninput="recalcAll()">
        </div>
        <div class="field-row">
          <label>Rate (%)</label>
          <input id="s1_rate" type="number" step="0.001" value="7.625" oninput="recalcAll()">
        </div>
        <div class="field-row">
          <label>PMI / Mortgage Insurance (monthly)</label>
          <input id="s1_pmi" type="number" value="0" oninput="recalcAll()">
        </div>

        <div class="summary" style="margin-top:8px;">
          <div class="summary-card">
            <label>Mortgage Payment – P&I</label>
            <div class="value" id="s1_pmtPI_text">$0</div>
          </div>
          <div class="summary-card">
            <label>Tax & Insurance (escrow)</label>
            <div class="value" id="s1_taxIns_text">$0</div>
          </div>
          <div class="summary-card">
            <label>Total Monthly Payment</label>
            <div class="value" id="s1_totalMonthly_text">$0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Closing costs grid -->
    <div class="card">
      <span class="badge">Closing Costs</span>
      <h2>Closing Cost Line Items</h2>
      <p class="subtitle">Rows 18–46 from your Sheet 1. You can adjust amounts; totals recalc automatically.</p>

      <div class="scroll">
        <table>
          <thead>
          <tr>
            <th>Description</th>
            <th>Paid To</th>
            <th>At Closing</th>
            <th>Before Closing</th>
          </tr>
          </thead>
          <tbody>
          <!-- rows 18–22 simple inputs -->
          <tr>
            <td>Lender Application Fee</td>
            <td>Lender</td>
            <td><input class="number-cell" id="s1_e18" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g18" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Electronic Registration</td>
            <td>Lender</td>
            <td><input class="number-cell" id="s1_e19" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g19" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Tax Service</td>
            <td>Lender</td>
            <td><input class="number-cell" id="s1_e20" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g20" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Flood Cert</td>
            <td>Lender</td>
            <td><input class="number-cell" id="s1_e21" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g21" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Rate Cost / Credit</td>
            <td>Lender</td>
            <td><input class="number-cell" id="s1_e22" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g22" type="number" value="0" oninput="recalcAll()"></td>
          </tr>

          <!-- per diem interest, row 23 -->
          <tr>
            <td>Per Diem Interest</td>
            <td>Lender</td>
            <td>
              <input class="number-cell" id="s1_e23" type="number" readonly>
            </td>
            <td><input class="number-cell" id="s1_g23" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Interest Credit?</td>
            <td class="muted">Checkbox = same logic as H23</td>
            <td colspan="2">
              <div class="inline">
                <input type="checkbox" id="s1_interestCredit" onchange="recalcAll()">
                <label class="muted">Check if using <em>interest credit</em> (use previous month to compute days)</label>
              </div>
            </td>
          </tr>

          <tr>
            <td>Credit Report</td>
            <td>Credit</td>
            <td><input class="number-cell" id="s1_e24" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g24" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Mortgage Tax</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e25" type="number" value="12801" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g25" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Lender's Title Policy</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e26" type="number" value="1266" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g26" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Recording – Mortgage</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e27" type="number" value="445" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g27" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Initial Escrow Payment</td>
            <td>Lender</td>
            <td><input class="number-cell" id="s1_e28" type="number" readonly></td>
            <td><input class="number-cell" id="s1_g28" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Settlement Fee</td>
            <td>Settlement Agent</td>
            <td><input class="number-cell" id="s1_e29" type="number" value="1800" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g29" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Appraisal</td>
            <td>AMC</td>
            <td><input class="number-cell" id="s1_e30" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g30" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Homeowners Insurance</td>
            <td>Insurance</td>
            <td><input class="number-cell" id="s1_e31" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g31" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Owner's Title Policy</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e32" type="number" value="6543" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g32" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Endorsements</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e33" type="number" value="250" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g33" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Searches</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e34" type="number" value="675" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g34" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Courier</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e35" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g35" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Title Closer</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e36" type="number" value="250" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g36" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Tax Escrow – Upcoming</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e37" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g37" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Recording fees</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e38" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g38" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Escrow Fee</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e39" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g39" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Title Sales Tax</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e40" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g40" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>CEMA Fee</td>
            <td>Settlement Agent</td>
            <td><input class="number-cell" id="s1_e41" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g41" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Transfer Tax</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e42" type="number" value="16500" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g42" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Mansion Tax</td>
            <td>Title Company</td>
            <td><input class="number-cell" id="s1_e43" type="number" value="0" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g43" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Property Tax paid to Seller</td>
            <td>Seller</td>
            <td><input class="number-cell" id="s1_e44" type="number" value="12799" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g44" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Condo Fee</td>
            <td>3rd Party</td>
            <td><input class="number-cell" id="s1_e45" type="number" value="50" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g45" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          <tr>
            <td>Buyer’s Attorney</td>
            <td>3rd Party</td>
            <td><input class="number-cell" id="s1_e46" type="number" value="1200" oninput="recalcAll()"></td>
            <td><input class="number-cell" id="s1_g46" type="number" value="0" oninput="recalcAll()"></td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="summary" style="margin-top:10px;">
        <div class="summary-card">
          <label>Total Closing Cost (at closing)</label>
          <div class="value" id="s1_totalClosing_text">$0</div>
        </div>
        <div class="summary-card">
          <label>Total Closing Cost (before closing)</label>
          <div class="value" id="s1_totalBefore_text">$0</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <span class="badge">Reserves</span>
        <h2>Reserves & Total Assets Needed</h2>
        <p class="subtitle">Matches your “Reserves” and “Total Assets Needed” block.</p>

        <div class="field-row">
          <label>Reserves (Months)</label>
          <input id="s1_reservesMonths" type="number" value="11" oninput="recalcAll()">
        </div>
        <div class="field-row">
          <label>Reserves Amount</label>
          <input id="s1_reservesAmount" type="number" value="103000" oninput="recalcAll()">
        </div>

        <div class="summary">
          <div class="summary-card">
            <label>Total Assets Needed</label>
            <div class="value" id="s1_totalAssets_text">$0</div>
          </div>
        </div>

        <p class="tagline">Total Assets Needed = Total Closing Cost (E47) + Reserves (E48) + Purchase price (E7) − Deposit (E8) − Seller Concession (E9) − Loan Amount (E10).</p>
      </div>
      <div class="card">
        <span class="badge">Notes</span>
        <h2>Disclaimer</h2>
        <p class="subtitle">Same idea as your note on the sheet.</p>
        <p class="tagline">
          This calculator is for information purposes only and does not constitute a formal Loan Estimate (LE) or Closing Disclosure (CD). 
          Actual figures may vary based on lender, title company, and final underwriting.
        </p>
      </div>
    </div>
  </section>

  <!-- ============ SHEET 2 ============ -->
  <section id="sheet2" class="sheet">
    <div class="card">
      <span class="badge">Escrow</span>
      <h2>Escrow Schedule (Month / Pay Out / Pay In / Balance)</h2>
      <p class="subtitle">This follows the logic of Sheet 2 rows 3–14 & E15.</p>

      <div class="field-row" style="max-width:260px;">
        <label>First Payment Date &nbsp;<span class="muted">(drives Month column)</span></label>
        <input id="s2_firstPaymentDate" type="date" oninput="recalcAll()">
      </div>

      <div class="scroll" style="margin-top:10px;">
        <table>
          <thead>
          <tr>
            <th>Month</th>
            <th>Pay Out (C)</th>
            <th>Pay In (D = total/12)</th>
            <th>Balance (E)</th>
          </tr>
          </thead>
          <tbody id="s2_tableBody">
          <!-- rows 3–14 will be filled via JS -->
          </tbody>
        </table>
      </div>

      <div class="summary" style="margin-top:10px;">
        <div class="summary-card">
          <label>Total Payout (Sheet3 A2)</label>
          <div class="value" id="s2_totalPayout_text">$0</div>
        </div>
        <div class="summary-card">
          <label>Initial Escrow Deposit (Sheet2 E15)</label>
          <div class="value" id="s2_initialEscrow_text">$0</div>
        </div>
      </div>

      <p class="tagline">
        In your Excel: D3–D14 = Sheet3!A2/12. E3 = E1 + D3 − C3, and each row’s balance feeds the next.
        E15 = A1 − A1*2 + A3 (based on Sheet 3). This page reproduces the same logic.
      </p>
    </div>
  </section>

  <!-- ============ SHEET 3 ============ -->
  <section id="sheet3" class="sheet">
    <div class="grid">
      <div class="card">
        <span class="badge">Summary</span>
        <h2>Escrow Summary</h2>
        <p class="subtitle">Direct translation of Sheet 3 cells A1–A3.</p>

        <div class="summary">
          <div class="summary-card">
            <label>Minimum Balance (A1)</label>
            <div class="value" id="s3_minBalance_text">$0</div>
          </div>
          <div class="summary-card">
            <label>Total Payout (A2)</label>
            <div class="value" id="s3_totalPayout_text">$0</div>
          </div>
          <div class="summary-card">
            <label>Cushion (A3)</label>
            <div class="value" id="s3_cushion_text">$0</div>
          </div>
        </div>

        <p class="tagline">
          A1 = MIN(Sheet2!E3:E14) &nbsp; | &nbsp;
          A2 = SUM(Sheet2!C3:C14) &nbsp; | &nbsp;
          A3 = A2/12*2
        </p>
      </div>
    </div>
  </section>
</div>

<script>
  // ---------- Helpers ----------
  const MS_PER_DAY = 1000 * 60 * 60 * 24;
  const s2Rows = Array.from({length: 12}, (_, i) => 3 + i); // 3..14

  function num(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const v = parseFloat(el.value);
    return isNaN(v) ? 0 : v;
  }

  function getDateFromInput(id) {
    const el = document.getElementById(id);
    if (!el || !el.value) return null;
    const d = new Date(el.value);
    return isNaN(d.getTime()) ? null : d;
  }

  function toCurrency(n) {
    if (!isFinite(n)) n = 0;
    return n.toLocaleString("en-US", {style: "currency", currency: "USD"});
  }

  function mround(x, multiple) {
    if (!isFinite(x)) return 0;
    return Math.round(x / multiple) * multiple;
  }

  function pmt(rate, nper, pv) {
    // Excel PMT; rate & nper as numbers, pv as positive loan amount -> negative payment
    if (rate === 0) return -(pv / nper);
    const r1 = Math.pow(1 + rate, nper);
    return -(pv * rate * r1) / (r1 - 1);
  }

  function eomonth(date, offset) {
    const d = new Date(date.getTime());
    d.setMonth(d.getMonth() + offset + 1, 0); // day 0 of next month = last of prev
    return d;
  }

  function edate(date, offset) {
    const d = new Date(date.getTime());
    const day = d.getDate();
    d.setMonth(d.getMonth() + offset);
    if (d.getDate() < day) {
      d.setDate(0);
    }
    return d;
  }

  function formatDateInput(d) {
    if (!d) return "";
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // ---------- Sheet 2: build rows once ----------
  (function buildSheet2Table() {
    const tbody = document.getElementById("s2_tableBody");
    s2Rows.forEach((row) => {
      const tr = document.createElement("tr");

      const tdMonth = document.createElement("td");
      const monthInput = document.createElement("input");
      monthInput.type = "date";
      monthInput.id = `s2_b${row}`;
      monthInput.oninput = recalcAll;
      tdMonth.appendChild(monthInput);

      const tdOut = document.createElement("td");
      const outInput = document.createElement("input");
      outInput.type = "number";
      outInput.className = "number-cell";
      outInput.id = `s2_c${row}`;
      outInput.oninput = recalcAll;
      tdOut.appendChild(outInput);

      const tdIn = document.createElement("td");
      const inInput = document.createElement("input");
      inInput.type = "number";
      inInput.className = "number-cell";
      inInput.id = `s2_d${row}`;
      inInput.readOnly = true;
      tdIn.appendChild(inInput);

      const tdBal = document.createElement("td");
      const balDiv = document.createElement("span");
      balDiv.id = `s2_e${row}`;
      tdBal.appendChild(balDiv);

      tr.appendChild(tdMonth);
      tr.appendChild(tdOut);
      tr.appendChild(tdIn);
      tr.appendChild(tdBal);
      tbody.appendChild(tr);
    });
  })();

  // ---------- Recalc functions ----------
  function recalcSheet2(state) {
    const firstPay = getDateFromInput("s2_firstPaymentDate");
    const totalPayout = s2Rows.reduce((sum, row) => sum + num(`s2_c${row}`), 0);
    const payInEach = totalPayout / 12;

    // Fill dates B3..B14
    s2Rows.forEach((row, idx) => {
      const monthInput = document.getElementById(`s2_b${row}`);
      if (firstPay && !monthInput.value) {
        const d = edate(firstPay, idx);
        monthInput.value = formatDateInput(d);
      }
    });

    let prevBalance = 0;
    let minBalance = null;

    s2Rows.forEach((row) => {
      const out = num(`s2_c${row}`);
      const din = payInEach;
      document.getElementById(`s2_d${row}`).value =
        isFinite(din) ? din.toFixed(2) : "";

      const bal = prevBalance + din - out;
      prevBalance = bal;

      document.getElementById(`s2_e${row}`).textContent = toCurrency(bal);

      if (minBalance === null || bal < minBalance) minBalance = bal;
    });

    const cushion = totalPayout / 12 * 2; // Sheet3 A3
    if (!isFinite(minBalance)) minBalance = 0;

    const initialEscrow = -minBalance + cushion; // Sheet2 E15

    document.getElementById("s2_totalPayout_text").textContent = toCurrency(totalPayout);
    document.getElementById("s2_initialEscrow_text").textContent = toCurrency(initialEscrow);

    // store for other sheets
    state.totalPayout = totalPayout;
    state.cushion = cushion;
    state.minBalance = minBalance;
    state.initialEscrow = initialEscrow;
  }

  function recalcSheet3(state) {
    const totalPayout = state.totalPayout || 0;
    const cushion = state.cushion || (totalPayout / 12 * 2);
    const minBalance = state.minBalance || 0;

    document.getElementById("s3_minBalance_text").textContent = toCurrency(minBalance);
    document.getElementById("s3_totalPayout_text").textContent = toCurrency(totalPayout);
    document.getElementById("s3_cushion_text").textContent = toCurrency(cushion);
  }

  function recalcSheet1(state) {
    const loanAmount = num("s1_loanAmount");
    const rate = num("s1_rate") / 100;
    const pmtPI = pmt(rate / 12, 360, loanAmount); // E12
    const totalPayout = state.totalPayout || 0;

    const taxInsMonthly = totalPayout / 12; // E13 = SUM(Sheet2!C3:C14)/12
    const pmiMonthly = num("s1_pmi");
    const totalMonthly = -pmtPI + taxInsMonthly + pmiMonthly; // E15

    document.getElementById("s1_pmtPI_text").textContent = toCurrency(-pmtPI);
    document.getElementById("s1_taxIns_text").textContent = toCurrency(taxInsMonthly);
    document.getElementById("s1_totalMonthly_text").textContent = toCurrency(totalMonthly);

    // Per diem interest (E23)
    const closingDate = getDateFromInput("s1_closingDate");
    const interestCredit = document.getElementById("s1_interestCredit").checked;
    let perDiemTotal = 0;

    if (closingDate && loanAmount && rate) {
      const basePerDay = mround(loanAmount * rate / 365, 0.01);
      const endDate = interestCredit
        ? eomonth(closingDate, -1)
        : eomonth(closingDate, 0);
      const days = Math.floor((endDate - closingDate) / MS_PER_DAY) + 1;
      perDiemTotal = basePerDay * days;
    }
    const e23 = document.getElementById("s1_e23");
    e23.value = perDiemTotal ? perDiemTotal.toFixed(2) : "";

    // Initial escrow (E28)
    const initialEscrow = state.initialEscrow || 0;
    document.getElementById("s1_e28").value =
      initialEscrow ? initialEscrow.toFixed(2) : "";

    // Sum closing costs E18:E46
    let totalClosing = 0;
    let totalBefore = 0;
    for (let r = 18; r <= 46; r++) {
      totalClosing += num(`s1_e${r}`);
      totalBefore += num(`s1_g${r}`);
    }
    document.getElementById("s1_totalClosing_text").textContent = toCurrency(totalClosing);
    document.getElementById("s1_totalBefore_text").textContent = toCurrency(totalBefore);

    // Total Assets Needed: E49 = E47 + E48 + E7 − E8 − E9 − E10
    const reservesAmount = num("s1_reservesAmount");
    const purchasePrice = num("s1_purchasePrice");
    const deposit = num("s1_contractDeposit");
    const sellerConcession = num("s1_sellerConcession");
    const totalAssets =
      totalClosing + reservesAmount + purchasePrice - deposit - sellerConcession - loanAmount;

    document.getElementById("s1_totalAssets_text").textContent = toCurrency(totalAssets);
  }

  function recalcAll() {
    const state = {};
    recalcSheet2(state);
    recalcSheet3(state);
    recalcSheet1(state);
  }

  // tabs
  document.querySelectorAll(".tab-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.sheet;
      document
        .querySelectorAll(".tab-btn")
        .forEach((b) => b.classList.toggle("active", b === btn));
      document
        .querySelectorAll(".sheet")
        .forEach((s) => s.classList.toggle("active", s.id === target));
    });
  });

  // initial calc
  recalcAll();
</script>
</body>
                  </html>
